<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MOH Internal — Login</title>
  <style>
    :root{font-family:system-ui,Segoe UI,Roboto,Arial;}
    body{display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f5f7fb;margin:0}
    .card{width:min(540px,95vw);background:#fff;padding:22px;border-radius:10px;box-shadow:0 6px 20px rgba(20,30,40,0.08)}
    .tabs{display:flex;gap:8px;margin-bottom:16px}
    .tab{flex:1;padding:10px 12px;text-align:center;cursor:pointer;border-radius:8px}
    .tab.active{background:#0b65d8;color:#fff}
    form{display:flex;flex-direction:column;gap:12px}
    input{padding:10px;border-radius:6px;border:1px solid #d6dbe6;font-size:15px}
    button{padding:10px;border-radius:6px;border:0;background:#0b65d8;color:#fff;font-weight:600;cursor:pointer}
    .muted{color:#6b7280;font-size:14px}
    .notice{padding:12px;border-radius:8px;background:#fff7cc;color:#6b4b00}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="card" id="app">
    <div class="tabs">
      <div class="tab active" id="tab-login">Login</div>
      <div class="tab" id="tab-signup">Sign Up</div>
    </div>

    <!-- LOGIN -->
    <form id="login-form">
      <input id="login-email" type="email" placeholder="email@moh.gov.my" required />
      <input id="login-password" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
      <div class="muted">Contact system administrator for inquiry</div>
      <div id="login-msg" class="muted"></div>
    </form>

    <!-- SIGNUP -->
    <form id="signup-form" class="hidden">
      <input id="signup-email" type="email" placeholder="email@moh.gov.my" required />
      <input id="signup-password" type="password" placeholder="Create password" required minlength="6" />
      <button type="submit">Sign Up</button>
      <div class="muted">Signup is limited to MOH email only.<br/> After verification, admin will approve your account.</div>
      <div id="signup-msg" class="muted"></div>
    </form>

    <!-- PENDING -->
    <div id="pending" class="hidden">
      <div class="notice">
        Your account is created and a verification email has been sent. <br/>
        After you verify your email, your account will be reviewed by an administrator. <br/>
        You will not be able to access protected pages until approved.
      </div>
    </div>

    <!-- ADMIN PANEL --> 
    <div id="admin-panel" class="hidden"> 
      <h3>Pending Users Approval</h3> 
      <ul id="pending-users-list"></ul> 
    </div>
  
  </div>
  <!-- Firebase v9 modules (CDN) -->
  <script type="module">
    // Import modular SDK from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // ====== REPLACE WITH YOUR FIREBASE CONFIG ======
    const firebaseConfig = {
      apiKey: "AIzaSyAlFPQGy38C_FLVdQYIVMLIvSVokM-M6AY",
      authDomain: "moh-internal.firebaseapp.com",
      projectId: "moh-internal",
      appId: "1:180577342810:web:aa3d824f62f177fe1dcf63"
    };
    // ==============================================

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const pendingEl = document.getElementById('pending');
    const protectedEl = document.getElementById('protected');
    const signupMsg = document.getElementById('signup-msg');
    const loginMsg = document.getElementById('login-msg');

    // Tabs
    const tabLogin = document.getElementById('tab-login');
    const tabSignup = document.getElementById('tab-signup');
    tabLogin.onclick = () => { tabLogin.classList.add('active'); tabSignup.classList.remove('active'); loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); pendingEl.classList.add('hidden'); protectedEl.classList.add('hidden'); }
    tabSignup.onclick = () => { tabSignup.classList.add('active'); tabLogin.classList.remove('active'); signupForm.classList.remove('hidden'); loginForm.classList.add('hidden'); pendingEl.classList.add('hidden'); protectedEl.classList.add('hidden'); }

    // helper: ensure MOH email
    function isMohEmail(email){
      return typeof email === 'string' && email.toLowerCase().endsWith('@moh.gov.my');
    }

    // SIGNUP
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupMsg.textContent = '';
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      if (!isMohEmail(email)) { signupMsg.textContent = 'Only @moh.gov.my emails allowed.'; return; }

      try {
        // create auth user
        const userCred = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCred.user;

        // send verification email
        await sendEmailVerification(user);

        // create a firestore user document (approved:false, role:user)
        const uDoc = doc(db, 'users', user.uid);
        await setDoc(uDoc, {
          email: email,
          approved: false,
          role: 'user',
          createdAt: serverTimestamp()
        });

        signupForm.classList.add('hidden');
        pendingEl.classList.remove('hidden');
        signupMsg.textContent = 'Verification email sent. After verifying, wait for admin approval.';
      } catch (err) {
        console.error(err);
        signupMsg.textContent = err.message || 'Signup failed';
      }
    });

    // LOGIN
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginMsg.textContent = '';
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      if (!isMohEmail(email)) { loginMsg.textContent = 'Only @moh.gov.my emails allowed.'; return; }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        // onAuthStateChanged handler will take over and show pending or protected
      } catch (err) {
        console.error(err);
        loginMsg.textContent = err.message || 'Login failed';
      }
    });

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      // hide all panels
      loginForm.classList.add('hidden');
      signupForm.classList.add('hidden');
      pendingEl.classList.add('hidden');
      protectedEl.classList.add('hidden');
      tabLogin.classList.remove('active');
      tabSignup.classList.remove('active');

      if (!user) {
        // show default login tab
        tabLogin.classList.add('active');
        loginForm.classList.remove('hidden');
        return;
      }

      // user is signed in — check email verification
      await user.reload(); // ensure latest tokens
      if (!user.emailVerified) {
        // Show pending verification message
        signupForm.classList.add('hidden');
        loginForm.classList.add('hidden');
        pendingEl.classList.remove('hidden');
        document.getElementById('signup-msg').textContent = 'Please verify your email. A verification email was sent.';
        return;
      }

      // check /users/{uid}.approved
      const uRef = doc(db, 'users', user.uid);
      const uSnap = await getDoc(uRef);
      if (!uSnap.exists()) {
        // No user doc found — create one as fallback (role:user, approved:false)
        try {
          await setDoc(uRef, {
            email: user.email,
            approved: false,
            role: 'user',
            createdAt: serverTimestamp()
          });
        } catch (err) {
          console.error('fallback create user doc failed', err);
        }
        pendingEl.classList.remove('hidden');
        return;
      }
      const data = uSnap.data();
      if (!data.approved) {
        pendingEl.classList.remove('hidden');
        return;
      }

      // approved user -> show protected content
      protectedEl.classList.remove('hidden');
    });

    // Logout
    document.getElementById('logout').addEventListener('click', () => auth.signOut());

  </script>
</body>
</html>
